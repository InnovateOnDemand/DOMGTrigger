  # Docs for the Azure Web Apps Deploy action: https://github.com/azure/functions-action
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy dotnet core project to Azure Function App - UploadTriggerV2

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './Trigger' # set this to the path to your function app project
  DOTNET_VERSION: '8.0.x' # set this to the dotnet version to use

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 'Build and publish Function App'
        shell: bash
        run: |
          pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Deploy using WebDeploy'
        shell: bash
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import subprocess
          import os
          
          # Write publish profile from secret to temp file
          profile_xml = """${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_V2 }}"""
          
          # Parse XML
          root = ET.fromstring(profile_xml)
          
          # Get the first publishProfile (MSDeploy)
          profile = root.find('publishProfile')
          
          if profile:
              publish_url = profile.get('publishUrl')
              username = profile.get('userName')
              password = profile.get('userPWD')
              
              print(f"Deploy URL: {publish_url}")
              print(f"Username: {username[:10]}...")
              
              # Create zip file
              result = subprocess.run(['zip', '-r', './Trigger/output.zip', '.'], 
                                    cwd='./Trigger/output',
                                    capture_output=True, text=True)
              print(f"Zip result: {result.returncode}")
              
              # Deploy using WebDeploy
              deploy_cmd = ['curl', '-X', 'POST', '-u', f'{username}:{password}', 
                          '--data-binary', '@./Trigger/output.zip', 
                          f'{publish_url}/api/zipdeploy']
              result = subprocess.run(deploy_cmd, capture_output=True, text=True)
              print(f"Deploy status: {result.returncode}")
              print(result.stdout)
              if result.stderr:
                  print(result.stderr)
          EOF