  # Docs for the Azure Web Apps Deploy action: https://github.com/azure/functions-action
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy dotnet core project to Azure Function App - UploadTriggerV2

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './Trigger' # set this to the path to your function app project
  DOTNET_VERSION: '8.0.x' # set this to the dotnet version to use

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 'Build and publish Function App'
        shell: bash
        run: |
          pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Deploy using WebDeploy'
        shell: bash
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import subprocess
          import os
          
          # Parse publish profile
          profile_xml = """${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_V2 }}"""
          root = ET.fromstring(profile_xml)
          profile = root.find('publishProfile')
          
          if profile:
              # Extract credentials
              publish_url = profile.get('publishUrl')
              username = profile.get('userName')
              password = profile.get('userPWD')
              
              # Ensure https:// prefix
              if not publish_url.startswith('https://'):
                  deploy_url = f'https://{publish_url}/api/zipdeploy'
              else:
                  deploy_url = f'{publish_url}/api/zipdeploy'
              
              print(f"Deploy URL: {deploy_url}")
              print(f"Username: {username[:10]}...")
              
              # Create zip from output directory
              result = subprocess.run(['zip', '-r', 'output.zip', '.'], 
                                    cwd='./Trigger/output',
                                    capture_output=True, text=True)
              if result.returncode != 0:
                  print(f"Zip failed: {result.stderr}")
                  exit(1)
              print(f"Zip created successfully")
              
              # Deploy using curl
              deploy_cmd = ['curl', '-X', 'POST', 
                          '-u', f'{username}:{password}',
                          '--data-binary', '@Trigger/output/output.zip',
                          deploy_url]
              
              result = subprocess.run(deploy_cmd, capture_output=True, text=True)
              print(f"Deploy status code: {result.returncode}")
              print(f"Response: {result.stdout}")
              if result.stderr:
                  print(f"Error: {result.stderr}")
          EOF